<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Termo de Responsabilidade (v17-Soma+Contracheque+CEP)</title>

    <script>
        // SCRIPT DE GUARDA DE AUTENTICAÇÃO
        if (localStorage.getItem('isAuthenticated') !== 'true') {
            // Se não estiver autenticado, redireciona IMEDIATAMENTE para o login
            alert("Acesso negado. Por favor, faça o login.");
            window.location.replace('index.html');
        }
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
        integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@latest/dist/tesseract.min.js'></script>

    <style>
        /* --- CORREÇÃO DE LAYOUT --- */
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 30px;
            padding: 20px;
            font-size: 14px;
            flex-wrap: wrap;
        }

        #form-container {
            flex: 0 0 450px;
            background: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 20px;
            max-height: 95vh;
            overflow-y: auto;
        }

        #form-container h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 25px;
            font-size: 1.5rem;
            color: #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #btn-logout {
            font-size: 0.8rem;
            font-weight: bold;
            padding: 5px 10px;
            border: 1px solid #dc3545;
            color: #dc3545;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        #btn-logout:hover {
            background: #dc3545;
            color: #fff;
        }

        .form-section {
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 20px;
        }

        .form-section:last-of-type {
            border-bottom: none;
            padding-bottom: 0;
        }

        .form-section h2 {
            font-size: 1.1rem;
            color: #333;
            margin-top: 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section h2 .btn-limpar {
            font-size: 0.8rem;
            font-weight: normal;
            padding: 2px 8px;
            border: 1px solid #dc3545;
            color: #dc3545;
            background: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-section h2 .btn-limpar:hover {
            background: #dc3545;
            color: #fff;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
            color: #555;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* --- NOVO: Estilo para inputs "buscando" --- */
        .form-group input[type="text"]:disabled {
            background-color: #e9ecef;
        }


        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 80px;
            gap: 10px;
        }

        .grid-4-dinamico {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 30px;
            gap: 10px;
            align-items: flex-end;
        }

        .grid-4-dinamico .form-group {
            margin-bottom: 0;
        }

        .grid-4-dinamico label,
        .grid-2 label,
        .grid-3 label {
            font-size: 0.8rem;
        }

        #gerar-pdf {
            display: block;
            width: 100%;
            padding: 12px;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease;
            background-color: #007bff;
        }

        #gerar-pdf:hover:not(:disabled) {
            background-color: #0056b3;
        }

        #gerar-pdf:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        /* --- PREVIEW E DOCUMENTO --- */
        #preview-container {
            flex: 1;
            display: flex;
            justify-content: center;
            min-width: 1mm;
        }

        #documento-completo {
            width: 158mm;
            padding: 0;
            margin: 0;
            background: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            font-family: 'Times New Roman', Times, serif;
            color: #000;
            font-size: 10pt;
            line-height: 1.5;
        }

        .variavel {
            font-weight: bold;
            color: #0d47a1;
            transition: color 0.3s ease;
            display: inline;


        }

        .generating-pdf .variavel {
            color: #000;
            font-weight: normal;
        }

        #documento-completo p {
            text-align: left;
            margin-bottom: 15px;
            text-indent: 50px;
            word-wrap: break-word;
        }

        #documento-completo .no-indent {
            text-indent: 0;
        }

        #documento-completo .clausula {
            font-weight: bold;
            text-transform: uppercase;
            margin-top: 20px;
            margin-bottom: 10px;
            text-indent: 0;
        }

        #documento-completo .paragrafo {
            margin-left: 25px;
            text-indent: 0;
        }

        #documento-completo .data-local {
            text-align: center;
            margin-top: 30px;
            text-indent: 0;
            page-break-inside: avoid !important;
        }

        /* --- SOLUÇÃO "EXPLICITA" PARA QUEBRA DE PÁGINA --- */
        .quebra-pagina-explicita {
            display: block;
            height: 1px;
            width: 100%;
            page-break-before: always !important;
            break-before: always !important;
            margin: 0;
            padding: 0;
            visibility: hidden;
        }

        /* --- ESTILOS DE TABELA --- */
        .preview-table {
            width: 100%;
            table-layout: fixed;
            border-collapse: collapse;
            margin-bottom: 20px;
            /* Espaço padrão abaixo das tabelas */
        }

        .preview-table-contratos {
            table-layout: fixed;
            margin-top: 30px;
        }

        /* AJUSTE: Tabela "BANCO NOVO" tem menos espaço embaixo */
        #tabela-banco-novo {
            margin-bottom: 0;
            /* Remove a margem de baixo */
        }

        .preview-table-contratos th {
            border: 1px solid #000;
            padding: 4px;
            font-weight: bold;
            text-align: center;
            background-color: #f2f2f2;
            white-space: normal;
            overflow-wrap: break-word;
            word-break: break-word;
        }

        .preview-table-contratos td {
            border: 1px solid #000;
            padding: 4px 6px;
            vertical-align: middle;
            text-align: center;
            white-space: normal;
            overflow-wrap: break-word;
        }

        /* --- BLOCOS DE DADOS --- */
        /* CORREÇÃO (Imagem 1): Aumentado espaço entre blocos (Page 1) */
        .bloco-dados {
            margin-bottom: 40px;
        }

        .bloco-titulo {
            text-align: center;
            font-weight: bold;
            background-color: #f2f2f2;
            padding: 4px 6px;
            border: 1px solid #000;
            font-size: 10pt;
            margin: 0;
            border-bottom: none;
        }

        .bloco-dados .dado-linha {
            margin: 0;
            padding: 4px 6px;
            text-indent: 0;
            border-left: 1px solid #000;
            border-right: 1px solid #000;
            border-bottom: 1px solid #eee;
            line-height: 1.4;
        }

        .bloco-dados .dado-linha:last-child {
            border-bottom: 1px solid #000;
        }

        .bloco-dados .dado-linha strong {
            font-weight: bold;
        }

        /* --- ASSINATURAS --- */
        .assinatura-bloco {
            margin-top: 40px;
            text-indent: 0;
            font-weight: bold;
            page-break-inside: avoid !important;
            display: table;
            width: 100%;
            table-layout: fixed;
            line-height: 1.2;
        }

        #primeira-assinatura {
            margin-bottom: 30px;
        }

        .assinatura-bloco span {
            text-align: center;
            display: table-cell;
            width: 50%;
            vertical-align: top;
            line-height: 1.2;
            /* <-- ADICIONE ESTA LINHA */
        }

        /* CORREÇÃO (Imagem 2): Grupo de valores de texto (Page 2) */
        .grupo-valores-texto {
            margin-top: 10px;
            /* Espaço pequeno após a tabela */
            margin-bottom: 15px;
            /* Espaço padrão antes do próximo parágrafo */
        }

        /* CORREÇÃO (Imagem 2): Reduz espaço entre as linhas de valor */
        .grupo-valores-texto p {
            margin-bottom: 5px;
        }

        /* --- OUTROS COMPONENTES --- */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1090;
        }

        .toast {
            width: 350px;
            max-width: 90%;
            background-color: #333;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateX(100%);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.bg-success {
            background-color: #198754;
        }

        .toast.bg-danger {
            background-color: #dc3545;
        }

        .toast.bg-warning {
            background-color: #ffc107;
            color: #000;
        }

        .upload-area {
            border: 2px dashed #007bff;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: background-color 0.2s, border-color 0.2s;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .upload-area.hover {
            background-color: #e9ecef;
            border-color: #0056b3;
        }

        #pdf-upload {
            display: none;
        }

        .upload-area span {
            font-weight: bold;
            color: #007bff;
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #contract-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1050;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #contract-modal {
            background: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        #contract-modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        #contract-modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        /* === NOVO: CSS PARA O SUMARIZADOR === */
        #modal-sum-container {
            padding: 12px 15px;
            background: #f0f2f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 1.05rem;
            text-align: center;
            display: none;
            /* Começa escondido */
            font-weight: 500;
        }

        #modal-sum-container strong {
            font-size: 1.1rem;
            color: #198754;
            /* Verde (sucesso) */
        }

        /* === FIM DO NOVO CSS === */


        #contract-list .form-check {
            display: block;
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }

        /* --- NOVO: Hover para os itens da lista --- */
        #contract-list .form-check:hover {
            background-color: #f8f9fa;
        }

        #contract-list .form-check.select-all:hover {
            background-color: transparent;
        }

        /* --- FIM DO NOVO HOVER --- */

        #contract-modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        #btn-add-contrato {
            width: 100%;
            margin-top: 15px;
            padding: 10px;
            background: #e6f7ff;
            border: 1px dashed #007bff;
            color: #007bff;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-remover-contrato {
            background: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            padding-bottom: 3px;
        }

        /* * ESTA CLASSE É A SOLUÇÃO PARA O html2pdf.js
         * Ela é ativada no <body> via JS antes de gerar o PDF
         * e removida depois.
        */
        @media print,
        (min-width: 0px) {
            .jsPDF-native-generating {
                display: block;
                background-color: #fff;
                padding: 0;
                margin: 0;
            }

            /* Esconde tudo que NÃO é o documento */
            .jsPDF-native-generating #form-container,
            .jsPDF-native-generating .toast-container,
            .jsPDF-native-generating #loading-overlay,
            .jsPDF-native-generating #contract-modal-overlay {
                display: none;
            }

            /* Faz o container do preview ocupar a tela toda */
            .jsPDF-native-generating #preview-container {
                flex: none;
                justify-content: flex-start;
                /* Alinha na esquerda */
                margin: 0;
                padding: 0;
                min-width: 0;
            }

            /* Remove sombras e margens do documento */
            .jsPDF-native-generating #documento-completo {
                box-shadow: none;
                margin: 0;
            }
        }
    </style>
</head>

<body>

    <div class="toast-container" id="toast-container"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <span id="loading-text">Analisando PDF...</span>
    </div>

    <div id="contract-modal-overlay">
        <div id="contract-modal">
            <div id="contract-modal-header">
                <h3>Selecione os Contratos</h3>
            </div>
            <div id="contract-modal-body">
                <div id="infoClienteModal" class="p-2 mb-3"
                    style="background: #f0f2f5; border-radius: 4px; border: 1px solid #ddd; display: none;">
                    <p class="mb-1"><strong>Cliente:</strong> <span id="modal-nome-cliente"></span></p>
                    <p class="mb-0"><strong>CPF:</strong> <span id="modal-cpf-cliente"></span></p>
                </div>
                <div id="contract-list">
                </div>

                <div id="modal-sum-container">
                    Soma das parcelas selecionadas: <strong id="modal-sum-value">R$ 0,00</strong>
                </div>
            </div>
            <div id="contract-modal-footer">
                <button id="modal-cancel-btn" class="modal-btn btn-secondary">Cancelar</button>
                <button id="modal-apply-btn" class="modal-btn btn-primary">Aplicar Selecionados</button>
            </div>
        </div>
    </div>


    <div id="form-container">
        <h1>
            Gerar Termo
            <button id="btn-logout" title="Sair do sistema">Sair</button>
        </h1>

        <div class="form-section">
            <h2>Dados do Cliente</h2>
            <div class="form-group"> <label for="nome-cliente">Nome Completo:</label> <input type="text"
                    id="nome-cliente" placeholder="Carlos Jorge Ferreira Lopes"> </div>
            <div class="grid-2">
                <div class="form-group"><label for="cpf-cliente">CPF:</label><input type="text" id="cpf-cliente"
                        placeholder="241.210.456-53"></div>
                <div class="form-group"><label for="rg-cliente">RG:</label><input type="text" id="rg-cliente"
                        placeholder="1568.146"></div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label for="rg-emissor">Órgão Expedidor:</label><input type="text"
                        id="rg-emissor" placeholder="SSP-MG"></div>
                <div class="form-group"><label for="naturalidade">Naturalidade:</label><input type="text"
                        id="naturalidade" placeholder="BELO HORIZONTE-MG"></div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label for="estado-civil">Estado Civil:</label><input type="text"
                        id="estado-civil" placeholder="VIÚVO"></div>
                <div class="form-group"><label for="profissao">Profissão:</label><input type="text" id="profissao"
                        placeholder="AGENTE DE SAUDE PUBLICA"></div>
            </div>
            <div class="form-group"> <label for="orgao-vinculado">Vinculado ao Órgão:</label> <input type="text"
                    id="orgao-vinculado" placeholder="MINISTERIO DA SAÚDE"> </div>
            <div class="grid-2">
                <div class="form-group"><label for="nome-pai">Nome do Pai:</label><input type="text" id="nome-pai"
                        placeholder="(Opcional)"></div>
                <div class="form-group"><label for="nome-mae">Nome da Mãe:</label><input type="text" id="nome-mae"
                        placeholder="JOVENTINA FERRERA LOPES"></div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label for="telefone">Telefone/Whatsapp:</label><input type="text" id="telefone"
                        placeholder="(38) 991058881"></div>
                <div class="form-group"><label for="email">E-mail:</label><input type="text" id="email"
                        placeholder="carlosjorge57@yahoo.com.br"></div>
            </div>

            <div class="grid-3">
                <div class="form-group" style="grid-column: span 3;"><label for="cep">CEP (Digite e saia do campo para
                        buscar):</label><input type="text" id="cep" placeholder="39480-000">
                </div>
            </div>
            <div class="form-group"><label for="logradouro">Logradouro:</label><input type="text" id="logradouro"
                    placeholder="Rua E número 340"></div>
            <div class="form-group"><label for="bairro">Bairro:</label><input type="text" id="bairro"
                    placeholder="Residencial Lagoa do Velho Chico"></div>
            <div class="grid-2">
                <div class="form-group"><label for="cidade">Cidade:</label><input type="text" id="cidade"
                        placeholder="JANUARIA"></div>
                <div class="form-group"><label for="estado">Estado:</label><input type="text" id="estado"
                        placeholder="MG"></div>
            </div>
        </div>

        <div class="form-section">
            <h2>Contratos a Quitar <button class="btn-limpar" id="limpar-contratos-btn">Limpar</button></h2>

            <input type="file" id="pdf-upload" accept=".pdf">
            <label for="pdf-upload" class="upload-area" id="upload-label">
                <span>Clique ou arraste o Extrato/Contracheque PDF</span>
            </label>

            <div id="contratos-dinamicos-container"
                style="display: flex; flex-direction: column; gap: 15px; margin-top:15px;">
            </div>

            <button type="button" id="btn-add-contrato">
                + Adicionar Contrato Manualmente
            </button>
        </div>

        <div class="form-section">
            <h2>Valores da Operação (Cláusula 1)</h2>
            <div class="grid-2">
                <div class="form-group"><label for="banco-novo">Banco Novo:</label><input type="text" id="banco-novo"
                        placeholder="BRADESCO S.A" value="Bradesco S/A"></div>
                <div class="form-group"><label for="parcela-nova">Parcela Nova:</label><input type="text"
                        id="parcela-nova" placeholder="R$ 1.901,51" class="campo-moeda"></div>
            </div>
            <div class="grid-2">
                <div class="form-group"><label for="valor-devedor-tabela">Valor Devedor (Tabela):</label><input
                        type="text" id="valor-devedor-tabela" placeholder="R$ 85.500,00" class="campo-moeda"></div>
                <div class="form-group"><label for="valor-liquido-cliente-tabela">Valor Cliente (Tabela):</label><input
                        type="text" id="valor-liquido-cliente-tabela" placeholder="R$ 8.000,00" class="campo-moeda">
                </div>
            </div>
            <div class="form-group"><label for="prazo-novo">Prazo Novo:</label><input type="text" id="prazo-novo"
                    placeholder="96X" value="96x"></div>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
            <div class="form-group"><label for="valor-total-aproximado">Valor Total Aprox. Contrato:</label><input
                    type="text" id="valor-total-aproximado" placeholder="14.600,00" class="campo-moeda"></div>
            <div class="form-group"><label for="valor-liquido-cliente-texto">Valor Líquido Cliente
                    (Texto):</label><input type="text" id="valor-liquido-cliente-texto" placeholder="R$ 8.000,00"
                    class="campo-moeda"></div>
            <div class="form-group"><label for="valor-repassar-empresa">Valor Repasse Empresa
                    (Restituição):</label><input type="text" id="valor-repassar-empresa" placeholder="R$ 6.600,00"
                    class="campo-moeda"></div>
        </div>
        <div class="form-section">
            <h2>Local e Data</h2>
            <div class="form-group"> <label for="local-data">Local e Data:</label> <input type="text" id="local-data"
                    value=""> </div>
        </div>
        <button id="gerar-pdf">Gerar PDF</button>
    </div>

    <div id="preview-container">
        <div id="documento-completo">

            <div class="bloco-dados">
                <h3 class="bloco-titulo">DADOS DO CLIENTE</h3>
                <p class="dado-linha">
                    Nome do Cliente:
                    <span id="doc-nome-cliente" class="variavel">[Nome Cliente]</span>
                </p>
                <p class="dado-linha">
                    CPF do Cliente:
                    <span id="doc-cpf-cliente" class="variavel">[Cpf Cliente]</span>
                </p>
                <p class="dado-linha">
                    RG:
                    <span id="doc-rg-cliente" class="variavel">[Rg Cliente]</span> Orgão Expedidor:
                    <span id="doc-rg-emissor" class="variavel">[Rg Emissor]</span>
                </p>
                <p class="dado-linha">
                    Naturalidade:
                    <span id="doc-naturalidade" class="variavel">[Naturalidade]</span>
                </p>
                <p class="dado-linha">
                    Estado Civil:
                    <span id="doc-estado-civil" class="variavel">[Estado Civil]</span>
                </p>
                <p class="dado-linha">
                    Profissão:
                    <span id="doc-profissao" class="variavel">[Profissao]</span>
                </p>
                <p class="dado-linha">
                    Vinculado ao Órgão:
                    <span id="doc-orgao-vinculado" class="variavel">[Orgao Vinculado]</span>
                </p>
                <p class="dado-linha">
                    Nome do Pai:
                    <span id="doc-nome-pai" class="variavel">[Nome Pai]</span>
                </p>
                <p class="dado-linha">
                    Nome da Mãe:
                    <span id="doc-nome-mae" class="variavel">[Nome Mae]</span>
                </p>
                <p class="dado-linha">
                    Tel./Whatsapp:
                    <span id="doc-telefone" class="variavel">[Telefone]</span> E-mail: <span id="doc-email"
                        class="variavel">[Email]</span>
                </p>
                <p class="dado-linha">
                    Logradouro:
                    <span id="doc-logradouro" class="variavel">[Logradouro]</span>
                </p>
                <p class="dado-linha">
                    Bairro:
                    <span id="doc-bairro" class="variavel">[Bairro]</span>
                </p>
                <p class="dado-linha">
                    Cidade:
                    <span id="doc-cidade" class="variavel">[Cidade]</span>
                </p>
                <p class="dado-linha" style="border-bottom: 1px solid #000;"> Estado:
                    <span id="doc-estado" class="variavel">[Estado]</span> CEP: <span id="doc-cep"
                        class="variavel">[Cep]</span>
                </p>
            </div>

            <div class="bloco-dados">
                <h3 class="bloco-titulo">DADOS DA EMPRESA</h3>
                <p class="dado-linha">Razão Social: <span>POLLO PROMOTORA LTDA</span></p>
                <p class="dado-linha">CNPJ: <span>44.906.703/0001-59</span></p>
                <p class="dado-linha">Logradouro: <span>CSE 06 LOTE 30 SALA 205</span></p>
                <p class="dado-linha">Cidade: <span>BRASÍLIA</span></p>
                <p class="dado-linha" style="border-bottom: 1px solid #000;">
                    Estado: <span>DF</span>
                    CEP: <span>72025065</span>
                </p>
            </div>

            <div class="quebra-pagina-explicita">&nbsp;</div>

            <table class="preview-table preview-table-contratos" id="tabela-quitar">
                <thead>
                    <tr>
                        <th>BANCO A QUITAR</th>
                        <th>VALOR PARCELA</th>
                        <th>N DE CONTRATO</th>
                        <th>PAGAS/A VENCER</th>
                    </tr>
                </thead>
                <tbody id="doc-contratos-tbody">
                    <tr class="placeholder-row">
                        <td colspan="4">Nenhum contrato adicionado</td>
                    </tr>
                </tbody>
            </table>

            <p class="no-indent" style="font-size: 8pt; text-align: center;">Reconheço e concordo que este contrato
                poderá ser assinado por reconhecimento de firma em cartório de notas ou de forma eletrônica, nos termos
                da MP 2.200, sendo tal assinatura aceita e admitida como válidas pelas partes. Conforme o disposto na
                referida MP, este Termo, quando assinado eletronicamente, é admitido como autêntico, íntegro e válido.
            </p>

            <div class="assinatura-bloco" id="primeira-assinatura"> <span
                    class="contratante">________________________________________<br><span id="doc-nome-cliente-ass-1"
                        class="variavel">[Nome Cliente]</span><br>CONTRATANTE</span> <span
                    class="contratado">________________________________________<br>POLLO PROMOTORA
                    LTDA<br>CONTRATADO</span> </div>

            <p class="clausula">CLÁUSULA PRIMEIRA - DO VALOR</p>

            <table class="preview-table preview-table-contratos" id="tabela-banco-novo">
                <thead>
                    <tr>
                        <th>BANCO NOVO</th>
                        <th>PARCELA NOVA</th>
                        <th>SALDO DEVEDOR</th>
                        <th>VALOR DO CLIENTE</th>
                        <th>PRAZO:</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><span id="doc-banco-novo" class="variavel">[Banco Novo]</span></td>
                        <td><span id="doc-parcela-nova" class="variavel">[Parcela Nova]</span></td>
                        <td><span id="doc-valor-devedor-tabela" class="variavel">[Valor Devedor]</span></td>
                        <td><span id="doc-valor-liquido-cliente-tabela" class="variavel">[Valor Cliente]</span></td>
                        <td><span id="doc-prazo-novo" class="variavel">[Prazo]</span></td>
                    </tr>
                </tbody>
            </table>

            <div class="grupo-valores-texto">
                <p class="no-indent">Valor total aproximado do contrato na nova Instituição Financeira: <span
                        id="doc-valor-total-aproximado" class="variavel">[Valor Total Aproximado]</span></p>
                <p class="no-indent">Valor líquido acordado para o cliente: <span id="doc-valor-liquido-cliente-texto"
                        class="variavel">[Valor Liquido Cliente]</span></p>
                <p class="no-indent">Valor que o cliente irá repassar para a empresa a título de restituição do valor
                    emprestado mais os valores de comissionamento e juros: <span id="doc-valor-repassar-empresa"
                        class="variavel">[Valor Repassar Empresa]</span></p>
            </div>



            <p class="paragrafo">– O DEVEDOR está ciente de que, após a assinatura deste instrumento, o valor, ora
                confessado, poderá ser diverso do informado na Item 1.1 desta Cláusula, pelo fato de que a quitação dos
                empréstimos, quando realizada de forma antecipada, poderá gerar descontos ou acréscimos no valor, sendo
                este fato de exclusiva responsabilidade da Instituição Financeira emissora do boleto de quitação,
                podendo esta inclusive se recusar a prosseguir na operação.</p>

            <p class="clausula">CLÁUSULA SEGUNDA - DO PAGAMENTO</p>
            <p>2.1 - O DEVEDOR reconhece como legítima a dívida, ora confessada, e declara ciente de que o presente
                instrumento atende todos os requisitos da lei. Declara-se ainda na presente oportunidade como DEVEDOR
                comprometendo-se a pagar o valor descriminado no item 1.1 da Cláusula Primeira.</p>
            <p class="paragrafo">Parágrafo Primeiro: O pagamento deverá ser realizado em PARCELA ÚNICA no ato de
                liberação dos valores disponibilizados na conta do DEVEDOR pela nova instituição financeira contratada.
                Não sendo possível efetuar a liberação dos valores, independentemente do motivo , o DEVEDOR terá o prazo
                máximo de 24 (vinte e quatro) horas , para efetuar o pagamento do valor confessado neste instrumento à
                CREDORA, por meio de transferência na seguinte conta:</p>
            <div style="padding-left: 50px; text-indent: 0; font-weight: bold; font-size: 9pt;"> BANCO: 001 (BANCO DO
                BRASIL)<br> AGÊNCIA: 4733-3<br> CONTA: 48859-3<br> PIX: vinicius@estilopromotora.com.br<br> CNPJ:
                44.906.703/0001-59<br> TITULAR: POLLO PROMOTORA </div>
            <p class="paragrafo" style="margin-top: 15px;">Parágrafo Segundo: No caso de ocorrer a hipótese descrita no
                item 1.5, da Cláusula Primeira, deste instrumento, ou seja, a conclusão da operação resultar em alguma
                diferença de valor entre a recontratação e o recurso da CREDORA utilizado para fins de quitação do(s)
                contrato(s) bancário(s) anterior(es), o DEVEDOR terá o prazo de 05 (cinco) dias úteis para efetuar o
                adimplemento do saldo remanescente , por meio de transferência bancária, salvo melhor juízo entre as
                partes. O não pagamento no prazo acordado, enseja a aplicação das regras definidas na Cláusula Terceira
                deste instrumento.</p>
            <p class="clausula">CLÁUSULA TERCEIRA - DO INADIMPLEMENTO</p>
            <p>3.1 - Não havendo o pagamento do valor ora estipulado neste instrumento, na forma acordada no item 2.1 e
                parágrafos da Cláusula Segunda, fica DEVEDOR o constituído em mora, independentemente de interpelação
                judicial ou notificação, podendo a CREDORA efetuar o protesto da dívida no Cartório competente.</p>
            <p class="paragrafo">– O descumprimento deste acordo, seja total ou parcial , ensejará, a partir do
                inadimplento, o acréscimo de correção monetária , com base no índice INPC ou outro índice equivalente
                permitido em lei, juros de mora de 1% (um por cento) ao mês e multa moratória no importe de 10% (dez por
                cento) sobre o saldo devedor.</p>
            <p class="paragrafo">– Em caso de cobrança administrativa da dívida, será o valor inadimplido acrescido de
                honorários advocatícios na base de 10% (dez por cento) sobre o valor do débito autalizado.</p>
            <p class="paragrafo">– Fica ressalvado que caso fique evidenciada a ma-fé do DEVEDOR no inadimplemento das
                obrigações assumidas neste instrumento, a CREDORA efetuará as devidas comunicações dos fatos junto à
                respectiva autoridade policial, para fins de apuração de eventual crime e a subsequente aplicação das
                sanções criminais pertinentes.</p>
            <p class="paragrafo">– Em caso de inadimplemento, ainda, poderá a CREDORA incluir o nome do DEVEDOR nos
                cadastros de devedores do Serviço de Proteção ao Crédito (SPC, SERASA, etc.).</p>
            <p class="paragrafo">– A dívida, ora reconhecida e assumida pelo DEVEDOR como certa, líquida e exigível, no
                valor acima mencionado, aplica-se o disposto no art. 784, III, do CPC, haja vista o caráter de título
                executivo extrajudicial do presente instrumento de confissão de divida.– Havendo a confirmação do
                pagamento, a CREDORA compromete-se a dar baixa no que diz respeito exlcusivamente ao débito ora
                confessado, excluindo o nome do DEVEDOR do banco de dados do SPC, SERASA ou órgão que o valha.</p>
            <p class="clausula">CLÁUSULA QUARTA – DA MULTA POR ARREPENDIMENTO DO CONTRATO</p>
            <p>4.1 - Se qualquer das partes desistir expressamente do presente contrato, sem justo motivo, após a
                assinatura do mesmo, fica a parte infratora sujeita ao pagamento de multa no importe de 10% (dez por
                cento) sobre o valor da presente negociação, sem prejuízo de outras perdas e danos a serem apuradas.</p>
            <p class="clausula">CLÁUSULA QUINTA – DAS OBRIGAÇÕES DO DEVEDOR</p>
            <p class="paragrafo">Efetuar o pagamento na data fixada neste instrumento;</p>
            <p class="paragrafo">Informar a CREDORA sobre a insolvência civil, recuperação judicial ou extrajudicial,
                falência ou qualquer ação e execução declarada contra si;</p>
            <p class="paragrafo">Prestar todos os esclarecimentos e enviar os documentos necessários para a operação;
            </p>
            <p class="paragrafo">Encaminhar uma cópia legível destes termos por meio Whatsapp ao corretor e a via
                original destes termos, devidamente assinados e com firma reconhecida, para a sede da CREDORA, sendo o
                custo do envio a cargo do DEVEDOR;</p>
            <p class="paragrafo">Enviar o comprovante de envio deste instrumento e do termo de ciência para ciência da
                CREDORA e possibilitar o rastreio do objeto.</p>
            <p class="clausula">CLÁUSULA SEXTA – DAS OBRIGAÇÕES DO CREDOR</p>
            <p class="paragrafo">Receber o pagamento da dívida nos moldes estipulados neste termo;</p>
            <p class="paragrafo">Não divulgar a terceiros, nem utilizar quaisquer informações escritas ou verbais e/ou
                documentação do DEVEDOR, de que tome conhecimento, ou a que tenha acesso, conforme a Lei Geral de
                Proteção de Dados - LGPD e outras correlatas;</p>
            <p class="clausula">CLÁUSULA SÉTIMA – DAS DISPOSIÇÕES GERAIS</p>
            <p class="paragrafo">- O presente instrumento passa a vigorar entre as partes a partir da assinatura do
                mesmo.</p>
            <p class="paragrafo">- Em caso de ajuizamento de ação judicial todas as partes autorizam a citação e
                intimação via aplicativo WhatsApp, telegrama ou via e-mail, nos termos do artigo 190 do CPC.</p>
            <p class="paragrafo">As Partes reconhecem e concordam que este contrato poderá ser assinado por
                reconhecimento de firma em Cartório ou de forma eletrônica, nos termos da MP 2.200, sendo tal assinatura
                aceita e admitida como válidas pelas partes.</p>
            <p class="paragrafo">Conforme o disposto na referida MP, este contrato, quando assinado eletronicamente, é
                admitido pelas partes como autêntico, íntegro e válido.</p>
            <p class="paragrafo">- O presente instrumento em todos os seus termos é feito em caráter IRREVOGÁVEL E
                IRRETRATÁVEL, para ambas as partes, que prometem fazê-lo sempre bom, firme e valioso a todo tempo e
                lugar, respondendo pelos mesmos seus herdeiros e sucessores.</p>
            <p class="paragrafo">- A mera tolerância de uma das partes em relação ao descumprimento das cláusulas
                contidas neste instrumento ou o não exercício de qualquer direito nele previsto constituirá mera
                liberalidade, bem como não importará em renúncia, perdão, novação ou alteração da norma infringida.</p>
            <p class="paragrafo">- Este instrumento obriga igualmente todos os herdeiros e sucessores das partes, que
                deverão cumpri-lo em sua integralidade, qualquer que seja a forma de sucessão.</p>
            <p class="paragrafo">- As partes que assinam o presente documento confessam e declaram de forma expressa
                fazer a presente transação de livre e espontânea vontade, estando plenamente os envolvidos conscientes
                de suas condições físicas e mentais, não sofrendo qualquer interferência pôr parte de terceiros.</p>
            <p class="paragrafo">- Na hipótese de não pagamento e ocorrendo partilha de bens do DEVEDOR, fica a CREDORA,
                seus beneficiários, herdeiros e sucessores, autorizados a se habilitarem no processo de inventário e
                requererem junto ao cartório e/ou juiz competente o pagamento do débito, constante neste instrumento.
            </p>
            <p class="paragrafo">- O Devedor concorda em caráter irrevogável, irretratável e sem direito de
                arrependimento que, em caso de execução judicial, não havendo pagamento no prazo estipulado no Código de
                Processo Civil, o pagamento do débito será realizado mediante desconto em folha de pagamento
                (contracheque) em até 60 (sessenta) parcelas mensis e sucessivas, mesmo não havendo margem para
                consignação, que serão descontadas mediante ordem judicial.</p>
            <p class="paragrafo">- As partes ajustam e concordam que todas as notificações, citações, avisos ou
                comunicações exigidas, permitidas ou decorrentes deste contrato, por qualquer das partes contratantes a
                outra, deverão ser feitas por meio de e-mail, whatsapp, carta, com aviso de recebimento, todos dirigidos
                para os e-mails/telefones/endereços indicados na qualificação das partes, ou para aqueles que vierem a
                ser indicados por elas.</p>
            <p class="data-local"><span id="doc-local-data" class="variavel">[Local Data]</span></p>
            <div class="assinatura-bloco"> <span class="contratante">________________________________________<br><span
                        id="doc-nome-cliente-ass-2" class="variavel">[Nome Cliente]</span><br>CONTRATANTE</span> <span
                    class="contratado">________________________________________<br>POLLO PROMOTORA
                    LTDA<br>CONTRATADO</span> </div>
        </div>
    </div>


    <script>
        // --- NOVO: Variável global para guardar dados do cliente do PDF
        window.ultimoClientePDF = {};

        // --- LIMPEZA: Linha abaixo removida pois 'html2pdf.bundle.js' já contém o jsPDF
        // const { jsPDF } = window.jspdf;

        // === NOVO: Configuração do PDF.js (da Calculadora) ===
        // ## MELHORIA: Trocado template literal (`) por string simples (')
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';


        // --- FUNÇÕES UTILITÁRIAS (Existentes) ---
        // ## MELHORIA: Funções formatadas para melhor leitura
        const formatarMoeda = (v) => {
            if (typeof v === 'string') {
                if (v.startsWith('R$')) return v;
                v = moedaParaFloat(v);
            }
            return (v || 0).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
        };

        const moedaParaFloat = (v) => {
            // Remove "R$", espaços, pontos de milhar, e troca vírgula por ponto
            return parseFloat(String(v || '').replace('R$', '').trim().replace(/\./g, "").replace(",", ".")) || 0;
        };

        // Toast (Notificações)
        const showToast = (message, type = 'success') => {
            const toastContainer = document.getElementById('toast-container');
            const toastId = 'toast-' + Date.now();
            let bgClass = 'bg-success';
            if (type === 'danger') bgClass = 'bg-danger';
            if (type === 'warning') bgClass = 'bg-warning';

            const toastEl = document.createElement('div');
            toastEl.id = toastId;
            toastEl.className = `toast ${bgClass}`;
            toastEl.textContent = message;
            toastContainer.appendChild(toastEl);
            setTimeout(() => { toastEl.classList.add('show'); }, 10);
            setTimeout(() => {
                toastEl.classList.remove('show');
                setTimeout(() => toastEl.remove(), 300);
            }, 4000);
        };

        // --- FUNÇÃO ATUALIZAR PREVIEW (Existente) ---
        // --- NOVO: FUNÇÃO ATUALIZAR PREVIEW (Refatorada para campos dinâmicos) ---
        function atualizarPreview() {
            // Parte 1: Campos Estáticos (Cliente, Valores da Operação)
            const campos = {
                'nome-cliente': ['doc-nome-cliente', 'doc-nome-cliente-ass-1', 'doc-nome-cliente-ass-2'], 'cpf-cliente': ['doc-cpf-cliente'], 'rg-cliente': ['doc-rg-cliente'], 'rg-emissor': ['doc-rg-emissor'], 'naturalidade': ['doc-naturalidade'], 'estado-civil': ['doc-estado-civil'], 'profissao': ['doc-profissao'], 'orgao-vinculado': ['doc-orgao-vinculado'], 'nome-pai': ['doc-nome-pai'], 'nome-mae': ['doc-nome-mae'], 'telefone': ['doc-telefone'], 'email': ['doc-email'], 'logradouro': ['doc-logradouro'], 'bairro': ['doc-bairro'], 'cidade': ['doc-cidade'], 'estado': ['doc-estado'], 'cep': ['doc-cep'],
                /* Campos de contrato estáticos removidos daqui */
                'banco-novo': ['doc-banco-novo'], 'parcela-nova': ['doc-parcela-nova'], 'valor-devedor-tabela': ['doc-valor-devedor-tabela'], 'valor-liquido-cliente-tabela': ['doc-valor-liquido-cliente-tabela'], 'prazo-novo': ['doc-prazo-novo'], 'valor-total-aproximado': ['doc-valor-total-aproximado'], 'valor-liquido-cliente-texto': ['doc-valor-liquido-cliente-texto'], 'valor-repassar-empresa': ['doc-valor-repassar-empresa'], 'local-data': ['doc-local-data']
            };

            const camposMoeda = [ /* 'parcela-quitar-X' removidos */ 'parcela-nova', 'valor-devedor-tabela', 'valor-liquido-cliente-tabela', 'valor-total-aproximado', 'valor-liquido-cliente-texto', 'valor-repassar-empresa'];

            for (const formId in campos) {
                const inputElement = document.getElementById(formId);
                if (!inputElement) continue;

                const valor = inputElement.value;
                const docIds = campos[formId];

                docIds.forEach(docId => {
                    const el = document.getElementById(docId);
                    if (!el) return;

                    let valorFinal = valor;
                    // Formata Moeda (apenas para os campos de moeda que *não* são de contrato)
                    if (camposMoeda.includes(formId) && valor.trim() !== "") {
                        const valorNumerico = moedaParaFloat(valor);
                        valorFinal = formatarMoeda(valorNumerico);
                    }

                    if (valor.trim() === "") {
                        // Define placeholders padrão para campos vazios
                        const placeholderMap = {
                            'doc-nome-cliente': '[Nome Cliente]', 'doc-nome-cliente-ass-1': '[Nome Cliente]', 'doc-nome-cliente-ass-2': '[Nome Cliente]',
                            'doc-cpf-cliente': '[Cpf Cliente]', 'doc-rg-cliente': '[Rg Cliente]', 'doc-rg-emissor': '[Rg Emissor]',
                            'doc-naturalidade': '[Naturalidade]', 'doc-estado-civil': '[Estado Civil]', 'doc-profissao': '[Profissao]',
                            'doc-orgao-vinculado': '[Orgao Vinculado]', 'doc-nome-pai': '[Nome Pai]', 'doc-nome-mae': '[Nome Mae]',
                            'doc-telefone': '[Telefone]', 'doc-email': '[Email]', 'doc-logradouro': '[Logradouro]',
                            'doc-bairro': '[Bairro]', 'doc-cidade': '[Cidade]', 'doc-estado': '[Estado]', 'doc-cep': '[Cep]',
                            'doc-banco-novo': '[Banco Novo]', 'doc-parcela-nova': '[Parcela Nova]', 'doc-valor-devedor-tabela': '[Valor Devedor]',
                            'doc-valor-liquido-cliente-tabela': '[Valor Cliente]', 'doc-prazo-novo': '[Prazo]',
                            'doc-valor-total-aproximado': '[Valor Total Aprox.]', 'doc-valor-liquido-cliente-texto': '[Valor Liquido Cliente]',
                            'doc-valor-repassar-empresa': '[Valor Repassar]',
                            'doc-local-data': '[Local Data]',
                        };
                        valorFinal = placeholderMap[docId] || `[${docId}]`; // Usa o placeholder ou um genérico
                    }
                    el.textContent = valorFinal;
                });
            }

            // --- NOVO: Parte 2: Campos Dinâmicos (Tabela de Contratos) ---
            const tbody = document.getElementById('doc-contratos-tbody');
            const itemsContrato = document.querySelectorAll('.contrato-dinamico-item');
            tbody.innerHTML = ''; // Limpa a tabela

            if (itemsContrato.length === 0) {
                // Adiciona linha de placeholder se estiver vazio
                tbody.innerHTML = '<tr class="placeholder-row"><td colspan="4">Nenhum contrato adicionado</td></tr>';
            } else {
                itemsContrato.forEach(item => {
                    const banco = item.querySelector('.campo-banco').value || '[Banco]';
                    let parcela = item.querySelector('.campo-parcela').value;
                    const contrato = item.querySelector('.campo-contrato').value || '[Contrato]';
                    const pagas = item.querySelector('.campo-pagas').value || '[Pagas/Total]'; // Placeholder atualizado

                    // Formata a parcela (já deve estar formatada pelo 'blur', mas garantimos)
                    const parcelaFormatada = (parcela.trim() === "") ? '[Parcela]' : formatarMoeda(parcela);

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td><span class="variavel">${banco}</span></td>
                        <td><span class="variavel">${parcelaFormatada}</span></td>
                        <td><span class="variavel">${contrato}</span></td>
                        <td><span class="variavel">${pagas}</span></td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }


        // --- FUNÇÃO SETAR DATA (Existente) ---
        // ## MELHORIA: Função formatada para melhor leitura
        function setarDataAtual() {
            const meses = ["janeiro", "fevereiro", "março", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const hoje = new Date();
            const dia = hoje.getDate();
            const mesNome = meses[hoje.getMonth()];
            const ano = hoje.getFullYear();
            const dataFormatada = `BRASÍLIA/DF, ${dia} de ${mesNome} de ${ano}`;
            const campoData = document.getElementById('local-data');
            if (campoData.value === "") {
                campoData.value = dataFormatada;
            }
        }


        // --- FUNÇÃO GERAR PDF (NOVA - Usando html2pdf.js) ---
        // ***** CORREÇÃO DE LAYOUT (setTimeout) APLICADA AQUI *****
        async function gerarPdf() {
            const botao = document.getElementById('gerar-pdf');
            botao.textContent = 'Gerando PDF...';
            botao.disabled = true;

            const nomeInput = document.getElementById('nome-cliente');
            const nomePessoa = nomeInput.value || 'documento';
            const filename = `${nomePessoa.trim().replace(/\s+/g, '_')}_termo_responsabilidade.pdf`;

            const documentoCompleto = document.getElementById('documento-completo');

            // Garante que o preview está 100% atualizado antes de gerar
            atualizarPreview();

            // Configurações para o html2pdf
            const opt = {
                // Sua margem de 2.5cm (25mm)
                margin: [25, 25, 25, 25],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 }, // Imagem de alta qualidade
                html2canvas: {
                    scale: 2, // Dobra a resolução para melhor qualidade (anti-aliasing)
                    useCORS: true,// Permite carregar imagens externas se houver
                    scrollX: 0,
                    scrollY: 0
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                // Tenta respeitar as quebras de página do CSS
                pagebreak: {
                    mode: ['css', 'legacy', 'avoid-all'], // Tenta evitar cortes estranhos
                    before: '.quebra-pagina-explicita' // Usa sua classe de quebra!
                }
            };

            // Remove a classe 'variavel' para o PDF final
            documentoCompleto.classList.add('generating-pdf');

            // Usa a classe CSS para esconder o formulário e resetar o layout
            document.body.classList.add('jsPDF-native-generating');

            // ***** CORREÇÃO: Adiciona um PEQUENO ATRASO (50ms) *****
            // Isso força o navegador a "repintar" a tela (com o formulário oculto)
            // ANTES do html2pdf tentar tirar a "foto".
            // Isso corrige a "página em branco" e o "corte" no layout.
            setTimeout(() => {
                // Chama a nova biblioteca
                html2pdf().from(documentoCompleto).set(opt).save()
                    .then(() => {
                        // Sucesso
                        showToast("PDF gerado com sucesso!");
                    })
                    .catch((err) => {
                        // Erro
                        console.error("Erro ao gerar PDF:", err);
                        showToast("Ocorreu um erro ao gerar o PDF.", "danger");
                    })
                    .finally(() => {
                        // Sempre executa, limpando o estado
                        documentoCompleto.classList.remove('generating-pdf');

                        // Restaura o layout da página
                        document.body.classList.remove('jsPDF-native-generating');

                        botao.textContent = 'Gerar PDF';
                        botao.disabled = false;
                    });
            }, 150); // 150ms de atraso é o suficiente para o DOM atualizar.
        }


        // ##################################################################
        // ### INÍCIO - NOVAS FUNÇÕES (Lógica da Calculadora Adaptada) ###
        // ##################################################################

        // --- NOVO: LÓGICA PARA CONTRATOS DINÂMICOS ---

        // Função para adicionar uma nova linha de contrato no formulário
        function adicionarLinhaContrato(banco = '', parcela = '', contrato = '', pagas = '') {
            const container = document.getElementById('contratos-dinamicos-container');
            const novoContratoDiv = document.createElement('div');
            novoContratoDiv.className = 'grid-4-dinamico contrato-dinamico-item'; // Nova classe de grid

            // Formata a parcela para exibição no input
            const parcelaFormatada = (parcela === '' || parcela === 0) ? '' : formatarMoeda(parcela);

            // ## MELHORIA: Adicionado 'aria-label' ao botão remover para acessibilidade
            novoContratoDiv.innerHTML = `
                <div class="form-group">
                    <label>Banco:</label>
                    <input type="text" class="campo-banco" placeholder="BCO" value="${banco}">
                </div>
                <div class="form-group">
                    <label>Parcela:</label>
                    <input type="text" class="campo-parcela campo-moeda" placeholder="R$ 0,00" value="${parcelaFormatada}">
                </div>
                <div class="form-group">
                    <label>Contrato:</label>
                    <input type="text" class="campo-contrato" placeholder="Nº Contrato" value="${contrato}">
                </div>
                <div class="form-group">
                    <label>Pagas/Total:</label>
                    <input type="text" class="campo-pagas" placeholder="0/0" value="${pagas}">
                </div>
                <button type="button" class="btn-remover-contrato" title="Remover este contrato" aria-label="Remover este contrato">&times;</button>
            `;

            container.appendChild(novoContratoDiv);

            // Adiciona listeners aos novos inputs para reatividade
            novoContratoDiv.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', atualizarPreview);
            });

            // Re-aplica a máscara de moeda no novo campo
            const novoCampoMoeda = novoContratoDiv.querySelector('.campo-moeda');
            novoCampoMoeda.addEventListener('blur', function () {
                if (this.value.trim() !== "") {
                    const valorNumerico = moedaParaFloat(this.value);
                    this.value = formatarMoeda(valorNumerico);
                    atualizarPreview(); // Atualiza o preview após formatar
                }
            });
        }
        // --- FIM DA LÓGICA DINÂMICA ---


        function showLoading(message) {
            document.getElementById('loading-text').textContent = message || 'Analisando PDF...';
            document.getElementById('loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- NOVO: Função para atualizar a soma no Modal ---
        function atualizarSomaModal() {
            const container = document.getElementById('contract-list');
            const sumContainer = document.getElementById('modal-sum-container');
            const sumEl = document.getElementById('modal-sum-value');

            // Se os elementos não existirem, sai da função
            if (!container || !sumContainer || !sumEl) return;

            const checkedBoxes = container.querySelectorAll('.loan-checkbox:checked');
            let totalSoma = 0;

            checkedBoxes.forEach(cb => {
                totalSoma += parseFloat(cb.dataset.parcela || 0);
            });

            if (totalSoma > 0) {
                sumEl.textContent = formatarMoeda(totalSoma);
                sumContainer.style.display = 'block';
            } else {
                // Esconde o container se a soma for zero
                sumEl.textContent = formatarMoeda(0);
                sumContainer.style.display = 'none';
            }
        }


        function showContractModal(loans, cliente) {
            const listaDiv = document.getElementById('contract-list');
            const infoClienteDiv = document.getElementById('infoClienteModal');
            listaDiv.innerHTML = ''; // Limpa lista anterior

            // Preenche dados do cliente no modal
            if (cliente.nome || cliente.cpf) {
                document.getElementById('modal-nome-cliente').textContent = cliente.nome || 'Não lido';
                document.getElementById('modal-cpf-cliente').textContent = cliente.cpf || 'Não lido';
                infoClienteDiv.style.display = 'block';
            } else {
                infoClienteDiv.style.display = 'none';
            }

            // Adiciona "Selecionar Todos"
            listaDiv.innerHTML = `
                <div class="form-check select-all" style="border-bottom: 2px solid #ddd; background: #f8f9fa;">
                    <input class="form-check-input" type="checkbox" id="selectAllCheckbox" style="margin-top: 0.4em;">
                    <label class="form-check-label" for="selectAllCheckbox" style="font-weight: bold; font-size: 1rem;">Selecionar Todos</label>
                </div>`;

            if (loans.length === 0) {
                listaDiv.innerHTML += '<p style="text-align: center; padding: 10px;">Nenhum contrato de EMPRÉSTIMO (filtrado) encontrado.</p>';
            }

            // Adiciona contratos
            loans.forEach((loan, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'form-check';

                // Formata o status (Pagas/Total) para exibição
                const statusLabel = (loan.status && loan.status !== 'N/A') ? ` | Status: ${loan.status}` : '';
                const contratoLabel = (loan.contrato && loan.contrato !== 'N/A') ? `Contrato: ${loan.contrato} | ` : '';

                // --- MELHORIA VISUAL: Mostrar contrato no modal ---
                itemDiv.innerHTML = `
                    <input class="form-check-input loan-checkbox" type="checkbox" 
                            id="loan-${index}"
                            data-banco="${loan.banco}"
                            data-parcela="${loan.parcelaNum}"
                            data-status="${loan.status || ''}"
                            data-contrato="${loan.contrato || ''}">
                    <label class="form-check-label" for="loan-${index}">
                        <strong>${loan.banco}</strong>
                        <br><small>${contratoLabel}Parcela: ${formatarMoeda(loan.parcelaNum)}${statusLabel}</small>
                    </label>`;
                listaDiv.appendChild(itemDiv);
            });

            // Event listener do "Selecionar Todos"
            document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                document.querySelectorAll('.loan-checkbox').forEach(cb => cb.checked = e.target.checked);
                // --- NOVO: Atualiza a soma ao clicar em "Selecionar Todos" ---
                atualizarSomaModal();
            });

            // --- NOVO: Adiciona listener de 'change' ao container da lista ---
            // Isso captura cliques em qualquer checkbox
            listaDiv.addEventListener('change', (e) => {
                if (e.target.classList.contains('loan-checkbox')) {
                    // Sincroniza o "Selecionar Todos" se todos estiverem marcados/desmarcados
                    const allCheckboxes = document.querySelectorAll('.loan-checkbox');
                    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
                    document.getElementById('selectAllCheckbox').checked = allChecked;
                }
                // Atualiza a soma em qualquer mudança
                atualizarSomaModal();
            });

            // Mostra o modal
            document.getElementById('contract-modal-overlay').style.display = 'flex';

            // --- NOVO: Chama a função de soma ao abrir o modal ---
            atualizarSomaModal(); // Define o estado inicial (R$ 0,00)
        }

        function hideContractModal() {
            document.getElementById('contract-modal-overlay').style.display = 'none';
            // --- NOVO: Limpa o listener de 'change' ao fechar o modal
            // (Para evitar listeners duplicados se o modal for reaberto)
            const listaDiv = document.getElementById('contract-list');
            if (listaDiv) {
                // Remove o listener clonando o nó (método mais simples)
                listaDiv.parentNode.replaceChild(listaDiv.cloneNode(true), listaDiv);
            }
        }

        // --- NOVO: Função 'applySelectedContracts' (Refatorada) ---
        function applySelectedContracts() {
            const checkedBoxes = document.querySelectorAll('.loan-checkbox:checked');
            let contractsApplied = 0;

            // 1. Limpa os campos de contrato dinâmicos antes de preencher
            limparCamposContrato();

            // --- NOVO: SOMA AS PARCELAS E JOGA NO INPUT ---
            let totalSomaParcelas = 0;
            checkedBoxes.forEach(cb => {
                totalSomaParcelas += parseFloat(cb.dataset.parcela || 0);
            });

            // Só atualiza o campo se a soma for maior que zero
            if (totalSomaParcelas > 0) {
                const parcelaNovaInput = document.getElementById('parcela-nova');
                parcelaNovaInput.value = formatarMoeda(totalSomaParcelas);
                console.log(`Soma (R$ ${totalSomaParcelas}) aplicada ao campo 'parcela-nova'.`);
            }
            // --- FIM DA NOVA LÓGICA ---

            // 2. Preenche os dados do cliente (se existirem)
            const nomeClienteModal = document.getElementById('modal-nome-cliente').textContent;
            const cpfClienteModal = document.getElementById('modal-cpf-cliente').textContent;

            if (nomeClienteModal && nomeClienteModal !== 'Não lido') {
                document.getElementById('nome-cliente').value = nomeClienteModal;
            }
            if (cpfClienteModal && cpfClienteModal !== 'Não lido') {
                document.getElementById('cpf-cliente').value = cpfClienteModal;
            }

            // Preenche o Estado (UF) se foi lido do PDF
            if (window.ultimoClientePDF && window.ultimoClientePDF.estado) {
                document.getElementById('estado').value = window.ultimoClientePDF.estado;
            }

            // --- NOVO: Preenche Profissão (Função) e Órgão ---
            // (Verifica se a propriedade existe E não está vazia)
            if (window.ultimoClientePDF && window.ultimoClientePDF.profissao) {
                document.getElementById('profissao').value = window.ultimoClientePDF.profissao;
            }
            if (window.ultimoClientePDF && window.ultimoClientePDF.orgao) {
                document.getElementById('orgao-vinculado').value = window.ultimoClientePDF.orgao;
            }
            // --- FIM DA NOVA LÓGICA ---

            // 3. Preenche os campos de contrato (SEM LIMITE)
            checkedBoxes.forEach((cb, index) => {
                // Chama a nova função para adicionar a linha no formulário
                adicionarLinhaContrato(
                    cb.dataset.banco,
                    parseFloat(cb.dataset.parcela), // Passa o número
                    cb.dataset.contrato,
                    cb.dataset.status
                );
                contractsApplied++;
            });

            if (contractsApplied > 0) {
                showToast(`${contractsApplied} contrato(s) e dados do cliente importados!`, 'success');
            } else if (nomeClienteModal !== 'Não lido' || cpfClienteModal !== 'Não lido') {
                showToast("Dados do cliente importados!", "success");
            } else {
                showToast("Nenhum contrato foi selecionado.", "warning");
            }

            // 4. Atualiza o preview do documento
            atualizarPreview();

            // 5. Esconde o modal
            hideContractModal();
        }

        // --- NOVO: Função 'limparCamposContrato' (Refatorada) ---
        function limparCamposContrato() {
            // Limpa o container dinâmico
            document.getElementById('contratos-dinamicos-container').innerHTML = '';
            // (Não precisa mais chamar o atualizarPreview daqui, pois o botão de limpar
            // e o 'applySelectedContracts' já chamam o 'atualizarPreview' depois)
        }

        // --- NOVO: Função para buscar CEP via API (ViaCEP) ---
        async function buscarCep() {
            const cepInput = document.getElementById('cep');
            const cidadeInput = document.getElementById('cidade');
            const estadoInput = document.getElementById('estado');
            const logradouroInput = document.getElementById('logradouro');
            const bairroInput = document.getElementById('bairro');

            let cep = cepInput.value.replace(/\D/g, ''); // Limpa o CEP (deixa só números)

            if (cep.length !== 8) {
                // Não é um CEP válido, não faz nada
                // Se o campo de cidade estava "buscando", limpa
                if (cidadeInput.value === "Buscando...") {
                    cidadeInput.value = "";
                    estadoInput.value = "";
                }
                return;
            }

            // Mostra um "loading" simples nos campos
            cidadeInput.value = "Buscando...";
            estadoInput.value = "...";
            logradouroInput.value = "...";
            bairroInput.value = "...";

            try {
                const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                if (!response.ok) throw new Error('CEP não encontrado (erro de rede)');

                const data = await response.json();

                if (data.erro) {
                    showToast("CEP não encontrado.", "warning");
                    cidadeInput.value = "";
                    estadoInput.value = "";
                    logradouroInput.value = "";
                    bairroInput.value = "";
                    return;
                }

                // Preenche os campos com os dados da API
                logradouroInput.value = data.logradouro || '';
                bairroInput.value = data.bairro || '';
                cidadeInput.value = data.localidade || '';
                estadoInput.value = data.uf || '';

                showToast("Endereço preenchido!", "success");

                // Foca no próximo campo (ex: logradouro) para o usuário completar
                logradouroInput.focus();

            } catch (error) {
                console.error("Erro ao buscar CEP:", error);
                showToast("Erro ao buscar CEP. Verifique a conexão.", "danger");
                cidadeInput.value = "";
                estadoInput.value = "";
                logradouroInput.value = "";
                bairroInput.value = "";
            } finally {
                // Atualiza o preview com os dados novos (mesmo se der erro)
                atualizarPreview();
            }
        }

        // --- Lógica de Processamento de PDF (da Calculadora) ---

        // =================================================================
        // === FUNÇÃO EXÉRCITO (Lógica Antiga Adaptada) ===
        // =================================================================
        async function processarPdfExercicio(text) {

            // --- Arrays para armazenar os dados ---
            let loansArray = [];
            let clienteObject = { nome: 'Não lido', cpf: 'Não lido', estado: '' }; // Estado adicionado

            // --- Variáveis locais para dados do cliente ---
            let clienteCpfPDF = '';
            let clienteNomePDF = '';

            // Limpa o texto, removendo cabeçalhos de página e rodapés
            let cleanText = text.replace(/--- FIM DA PÁGINA \d+ ---/g, '')
                .replace(/Consignatária\n\s*▴\s*▾[\s\S]+?Situação\n\s*▴\s*▾/g, '') // Remove header de tabela limpa
                .replace(/Consignatária Nº Serviço Inclusão Vir.prest. Virfolha Nº Pagas Situação/g, ''); // Remove header de tabela OCR

            // --- DETECÇÃO AUTOMÁTICA DO TIPO DE TEXTO ---
            const isOcrText = cleanText.includes('O74-SABEMI-') || cleanText.includes('R$834/12') || cleanText.includes('R$74046');

            if (isOcrText) {
                // --- LÓGICA B: PARSER TOLERANTE PARA OCR (Tesseract) ---
                console.log("Detectado texto de OCR (Exército). Usando parser tolerante.");

                const cpfMatch = text.match(/(\d{3}\.\d{3}\.\d{3}-\d{2})/);
                const nomeMatch = text.match(/(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-ZÀ-Ú ]+)(?:\n([A-ZÀ-Ú ]+))?/);

                if (cpfMatch) {
                    clienteCpfPDF = cpfMatch[0];
                } else if (nomeMatch) {
                    clienteCpfPDF = nomeMatch[2].trim();
                }
                if (nomeMatch) {
                    clienteNomePDF = nomeMatch[3].trim() + (nomeMatch[4] ? ' ' + nomeMatch[4].trim() : '');
                }

                // (DOM-Manipulation-Removed)

                const blocos = cleanText.split(/Andamento/gi);
                blocos.forEach((bloco, index) => {
                    if (!bloco.toUpperCase().includes('EMPRÉSTIMO') && !bloco.toUpperCase().includes('DEDUT')) return;

                    let nomeBanco = 'Banco (Não lido)';
                    if (bloco.includes('SABEMI')) nomeBanco = 'SABEMI - PRIVADA';

                    const valorMatches = bloco.match(/R\$\s*([\d.,\/]+)/g);
                    if (!valorMatches) return;

                    let valorStr = valorMatches[valorMatches.length - 1];
                    valorStr = valorStr.replace('/', ',').replace(/[\[|]/g, '');

                    if (!valorStr.includes(',')) {
                        let digits = valorStr.replace(/R\$\s*/, '').trim();
                        if (digits.length > 2) {
                            valorStr = "R$ " + digits.slice(0, -2) + ',' + digits.slice(-2);
                        }
                    }
                    const valorParcelaNum = moedaParaFloat(valorStr);
                    if (valorParcelaNum === 0) return;

                    const parcelasMatch = bloco.match(/\s*([\w\.|]+)\s+([\w\d]+)\s+Em/s);
                    if (!parcelasMatch) {
                        console.warn('Contrato pulado (OCR não leu as parcelas):', bloco);
                        return;
                    }
                    let total = parcelasMatch[1].replace(/[\[|TP]/g, '').trim();
                    let pagas = parcelasMatch[2].replace(/[x|xi|nm]/g, '0');

                    if (isNaN(parseInt(pagas, 10)) || (total.toUpperCase() !== 'INDET.' && isNaN(parseInt(total, 10)))) {
                        console.warn('Contrato pulado (OCR leu lixo nas parcelas):', bloco);
                        return;
                    }

                    // Adiciona o contrato ao array
                    loansArray.push({
                        banco: nomeBanco,
                        parcelaNum: valorParcelaNum,
                        status: `${pagas} de ${total}`,
                        contrato: 'N/A' // OCR não pega contrato
                    });
                });
            } else {
                // --- LÓGICA A: PARSER ORIGINAL (Para PDF limpo) ---
                console.log("Detectado texto limpo (Exército). Usando parser padrão.");

                const infoRegex = /(\d{9,12})\s*-\s*([\d.-]+)\s*-\s*([A-ZÀ-Ú ]+)(?:\n([A-ZÀ-Ú ]+))?/;
                const infoMatch = text.match(infoRegex);

                if (infoMatch) {
                    clienteCpfPDF = infoMatch[2].trim();
                    clienteNomePDF = infoMatch[3].trim();
                    if (infoMatch[4]) {
                        clienteNomePDF += ` ${infoMatch[4].trim()}`;
                    }
                } else {
                    console.warn("Regex de Nome/CPF falhou no parser limpo (Exército).");
                }

                // (DOM-Manipulation-Removed)

                const blocos = cleanText.split(/\n(?=\d{3}\s*-\s*)/);
                blocos.forEach((bloco, index) => {
                    if (bloco.toUpperCase().includes('EMPRÉSTIMO') && /Em\s+Andamento/.test(bloco)) {
                        const bancoMatch = bloco.match(/^([\s\S]+?)\n(\d{7})\n/);
                        const valorMatch = bloco.match(/R\$\s*[\d.,]+/);
                        const parcelasMatch = /([\w\.]+)\s*\n\s*(\d+)\s+Em\s+Andamento/;
                        const parcelasResult = bloco.match(parcelasMatch);

                        if (bancoMatch && valorMatch && parcelasResult) {
                            const nomeBanco = bancoMatch[1].replace(/\n/g, ' ').trim();
                            const numContrato = bancoMatch[2].trim(); // Pega o contrato aqui
                            const valor = valorMatch[0];
                            const total = parcelasResult[1];
                            const pagas = parcelasResult[2];

                            if (total.toUpperCase() === 'INDET.') return;

                            const valorParcelaNum = moedaParaFloat(valor);

                            // Adiciona o contrato ao array
                            loansArray.push({
                                banco: nomeBanco,
                                parcelaNum: valorParcelaNum,
                                status: `${pagas} de ${total}`,
                                contrato: numContrato
                            });
                        }
                    }
                });
            }

            if (loansArray.length === 0) {
                // Em vez de showToast, apenas avisamos no console. 
                // O modal vai mostrar que a lista está vazia.
                console.warn("Nenhum contrato 'Em Andamento' foi encontrado no formato esperado.");
            }

            // Agrupa os dados do cliente para o retorno
            clienteObject.nome = clienteNomePDF || 'Não lido';
            clienteObject.cpf = clienteCpfPDF || 'Não lido';

            // Retorna o objeto final que o 'showContractModal' espera
            return { loans: loansArray, cliente: clienteObject };
        }

        // =================================================================
        // === FUNÇÃO SIAPE ATUALIZADA (CORREÇÃO CPF/NOME) ===
        // =================================================================
        async function processarPdfSiape(text) {
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: '' }; // Estado adicionado
            let loansFound = [];

            // --- TENTATIVA 1: Layout Novo (Layout "VALERIA" / "JANDA") ---
            console.log("Tentando Regex do SIAPE (Layout Novo)...");

            // 1. Extrair dados do cliente (Layout Novo)
            const infoRegexNovo = /CPF\nMatrícula\nNome\n(?:[^\n]+\n)([^\n]+)\n(?:[^\n]+\n)([^\n]+)/;

            let infoMatchNovo = text.match(infoRegexNovo);

            // --- CORREÇÃO (Layout "ANTONIO JOAO") ---
            if (!infoMatchNovo) {
                // Regex para o layout do "ANTONIO JOAO"
                const infoRegexAntonio = /CPF\n(?:[^\n]+\n)([^\n]+)\nMatrícula\s+(\d+)\nNome\n([A-ZÀ-Ú ]+)/;
                const infoMatchAntonio = text.match(infoRegexAntonio);
                if (infoMatchAntonio) {
                    console.log("Regex SIAPE (Layout Antonio) detectado.");
                    infoMatchNovo = [null, infoMatchAntonio[1], infoMatchAntonio[3]]; // Simula o formato do infoMatchNovo
                }
            }
            // --- FIM DA CORREÇÃO ---


            if (infoMatchNovo && infoMatchNovo[1] && infoMatchNovo[2]) {
                const cpfPotencial = infoMatchNovo[1].trim();
                if (/\d{3}\.\d{3}\.\d{3}-\d{2}/.test(cpfPotencial) || /\d{11}/.test(cpfPotencial.replace(/[.-]/g, ''))) {
                    cliente.cpf = cpfPotencial;
                    cliente.nome = infoMatchNovo[2].trim();
                    console.log("Cliente SIAPE (Novo) encontrado:", cliente.nome);
                } else {
                    console.warn("Regex SIAPE (Novo) encontrou dados, mas CPF parece inválido.");
                }
            } else {
                console.warn("Regex SIAPE (Novo) falhou.");
            }

            // 2. Extrair Contratos (Layout Novo)
            const rgxEmprestimosNovo = /^([^\n]+)\n(3\d{4}\s*-\s*EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/gm;
            let matches = [...text.matchAll(rgxEmprestimosNovo)];

            // --- CORREÇÃO (Layout "ANTONIO JOAO") ---
            if (matches.length === 0) {
                // Regex para a tabela do "ANTONIO JOAO" 
                // Formato: "35-868125886/21\n","34943-EMPREST...\n","1\n","10\n","...2021...\n","51/96\n","R$ 591,51\n"
                const rgxAntonioTabela = /"([\d-]+[\/\d]*)"\s*,\s*"(\d+-EMPREST[^"]+)"\s*,\s*"\d+"\s*,\s*"\d+"\s*,\s*"[^"]+"\s*,\s*"(\d+\/\d+)"\s*,\s*"(R\$\s*[\d.,]+)"/g;
                let matchesAntonio = [...text.matchAll(rgxAntonioTabela)];
                console.log(`Regex SIAPE (Tabela Antonio) encontrou ${matchesAntonio.length} contratos.`);

                matchesAntonio.forEach((match) => {
                    const [_, numContrato, nomeBanco, parcelasStr, valor] = match;
                    // Invertemos 'valor' e 'parcelasStr' para bater com a 'matches'
                    matches.push([null, numContrato, nomeBanco, valor, parcelasStr]);
                });
            }
            // --- FIM DA CORREÇÃO ---


            matches.forEach((match) => {
                const [_, numContrato, nomeBanco, valor, parcelasStr] = match;
                let cleanNomeBanco = nomeBanco.replace(/^\d+\s*-\s*/, '').replace('EMPREST BCO PRIVADOS - ', '').replace('EMPREST BCO OFICIAL - ', '').replace('EMPREST BCO PRIVADOS ', '').replace('EMPREST PREV PRIVADA - ', '').trim();
                const [pagas, total] = parcelasStr.split('/');
                const valorParcelaNum = moedaParaFloat(valor);
                if (parseInt(total, 10) > 900) return; // Ignora contribuições (999)
                loansFound.push({
                    banco: cleanNomeBanco,
                    parcelaNum: valorParcelaNum,
                    status: `${pagas.trim()} de ${total.trim()}`,
                    contrato: numContrato.trim()
                });
            });

            // --- TENTATIVA 2: Fallback para Layout Antigo (da Calculadora) ---
            if (loansFound.length === 0) {
                console.warn("Regex SIAPE (Novo Contratos) falhou. Tentando Regex antigo (da Calculadora)...");

                // 1. Extrair dados do cliente (Layout Antigo)
                if (cliente.cpf === 'Não lido') {
                    const headerRegexAntigo = /Órgão\nCPF\nMatrícula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
                    let headerMatchAntigo = text.match(headerRegexAntigo);
                    if (headerMatchAntigo) {
                        cliente.cpf = headerMatchAntigo[1].trim();
                        cliente.nome = headerMatchAntigo[2].trim();
                        console.log("Cliente SIAPE (Antigo) encontrado:", cliente.nome);
                    }
                }

                // 2. Extrair Contratos (Layout Antigo)
                const rgxAntigo = /(EMPREST[^\n]+)\n(?:.|\n)*?(R\$\s*[\d\.,]+)\n(\d{2,3}\/\d{2,3})/g;
                let matchesAntigo = [...text.matchAll(rgxAntigo)];

                matchesAntigo.forEach((match) => {
                    const [_, nomeBanco, valor, parcelasStr] = match;
                    let cleanNomeBanco = nomeBanco.replace(/^\d+\s*-\s*/, '').replace('EMPREST BCO PRIVADOS - ', '').replace('EMPREST BCO OFICIAL - ', '').trim();
                    const [pagas, total] = parcelasStr.split('/');
                    const valorParcelaNum = moedaParaFloat(valor);
                    if (parseInt(total, 10) > 900) return;
                    loansFound.push({
                        banco: cleanNomeBanco,
                        parcelaNum: valorParcelaNum,
                        status: `${pagas} de ${total}`,
                        contrato: 'N/A' // Contrato fica em branco no layout antigo
                    });
                });
            } // Fim do Fallback

            // Se nenhum Regex de cliente funcionou, tenta o fallback do antigo
            if (cliente.cpf === 'Não lido') {
                const headerRegexAntigo = /Órgão\nCPF\nMatrícula\nNome\n[^\n]+\n([^\n]+)\n[^\n]+\n([^\n]+)/;
                let headerMatchAntigo = text.match(headerRegexAntigo);
                if (headerMatchAntigo) {
                    cliente.cpf = headerMatchAntigo[1].trim();
                    cliente.nome = headerMatchAntigo[2].trim();
                    console.log("Cliente SIAPE (Antigo-Fallback) encontrado:", cliente.nome);
                }
            }

            return { loans: loansFound, cliente: cliente };
        }

        // =================================================================
        // === NOVO: FUNÇÃO PARA CONTRACHEQUE SERVIDOR (Ativo/Aposentado) ===
        // =================================================================
        async function processarPdfContrachequeServidor(text) {
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: '', profissao: '', orgao: '' };
            let loansArray = [];

            console.log("Processando como Contracheque SERVIDOR (SGP/SIGEPE)...");

            // 1. Extrair Dados do Cliente

            // --- INÍCIO DA CORREÇÃO 7 (Corrige a Regex do Órgão) ---

            // Regex para Nome e Profissão (Combinados): (Esta já estava funcionando)
            const nomeCargoMatch = text.match(/\n([A-ZÀ-Ú ]+)\s*\n\s*(\d{7,9})\s*\n\s*(\d{7,9})\s*\n\s*([A-ZÀ-Ú -]+)\s*\n\s*[A-Z]\s*\n\s*[A-Z]/);
            if (nomeCargoMatch) {
                cliente.nome = nomeCargoMatch[1].trim();
                cliente.profissao = nomeCargoMatch[4].trim().replace(/\s+/g, ' '); // Limpa espaços extras
                console.log("Regex (Servidor Nome/Profissao) A funcionou!", cliente.nome, cliente.profissao);
            } else {
                console.warn("Regex (Servidor Nome/Profissao) A falhou. Tentando Fallbacks...");
                const nomeMatchFallback = text.match(/NOME DO SERVIDOR(?:.|\n)+?([A-ZÀ-Ú ]{3,}\s[A-ZÀ-Ú ]{3,})/);
                if (nomeMatchFallback) cliente.nome = nomeMatchFallback[1].trim();
                const cargoMatchFallback = text.match(/CARGO\/EMPREGO(?:.|\n)+?([A-ZÀ-Ú -]+)\s*\n\s*[A-Z]\s*\n\s*[A-Z]\s+/);
                if (cargoMatchFallback) cliente.profissao = cargoMatchFallback[1].trim().replace(/\s+/g, ' ');
            }

            // Regex para CPF: (Esta já estava funcionando)
            const cpfMatch = text.match(/CPF\s*\n\s*(\d{11})/);
            if (cpfMatch && cpfMatch[1]) {
                cliente.cpf = cpfMatch[1].trim();
                console.log("Regex (Servidor CPF) A funcionou!", cliente.cpf);
            } else {
                console.warn("Regex (Servidor CPF) A falhou. Tentando Fallback B...");
                const cpfMatchFallbackB = text.match(/\n(\d{11})\s*\n\s*(\d{3})\s*\n\s*(\d{6})\s+/); // Layout Petrolinio
                if (cpfMatchFallbackB) {
                    cliente.cpf = cpfMatchFallbackB[1].trim();
                } else {
                    console.warn("Regex (Servidor CPF) B falhou. Tentando Fallback C...");
                    const cpfMatchFallbackC = text.match(/\n00\s*\n\s*00\s*\n\s*(\d{11})/); // Layout Petrolinio (seguro)
                    if (cpfMatchFallbackC) cliente.cpf = cpfMatchFallbackC[1].trim();
                }
            }

            // Regex para Órgão (Ministério):
            // --- ESTA É A CORREÇÃO ---
            // Procura pelo (NOME DO ÓRGÃO) que vem antes de \n NORMAL \n [MÊS] [ANO]
            // (Funciona para ambos os layouts de servidor)
            const orgaoMatch = text.match(/([A-ZÀ-Ú .]+)\s*\n\s*NORMAL\s*\n\s*(?:JAN|FEV|MAR|ABR|MAI|JUN|JUL|AGO|SET|OUT|NOV|DEZ) \d{4}/);
            if (orgaoMatch && orgaoMatch[1]) {
                cliente.orgao = orgaoMatch[1].trim();
                console.log("Regex (Servidor Órgão) A funcionou!", cliente.orgao);
            } else {
                console.warn("Regex (Servidor Órgão) A falhou.");
            }

            // Regex para Estado (UF): (Esta já estava funcionando)
            const ufMatch = text.match(/\n([A-Z]{2})\s*\n\s*EST\s*\n\s*([A-ZÀ-Ú ]+)/);
            if (ufMatch && ufMatch[1]) {
                cliente.estado = ufMatch[1].trim();
                console.log("Regex (Servidor UF) A funcionou!", cliente.estado);
            } else {
                console.warn("Regex (Servidor UF) A falhou.");
            }

            // --- FIM DA CORREÇÃO 7 ---

            // 2. Extrair Contratos (Descontos)
            // (Esta regex já estava funcionando bem para ambos os casos)
            const descontosRegex = /(?:(\d{3})\s*\n\s*)?([\d.,]+)\s*\n\s*((?:EMPREST|AMORT)[^\n]+)/g;
            let matches = [...text.matchAll(descontosRegex)];

            if (matches.length === 0) {
                console.log("Regex de Desconto A falhou. Tentando Fallback (B)...");
                const descontosRegexFallback = /(?:(\d{3})\s+)?([\d.,]+)\s+((?:EMPREST|AMORT)[^\n]+)/g;
                matches = [...text.matchAll(descontosRegexFallback)];
            }
            console.log(`Contracheque (Servidor): Encontrados ${matches.length} descontos.`);

            matches.forEach((match) => {
                const prazo = match[1] || 'N/A';
                const valorStr = match[2];
                const nomeBanco = match[3].trim();
                const valorParcelaNum = moedaParaFloat(valorStr);

                if (valorParcelaNum > 5.00) {
                    loansArray.push({
                        banco: nomeBanco.replace(/\s+/g, ' '), // Limpa quebras de linha no nome do banco
                        parcelaNum: valorParcelaNum,
                        status: `Prazo: ${prazo}`,
                        contrato: 'N/A'
                    });
                }
            });

            return { loans: loansArray, cliente: cliente };
        }

        // =================================================================
        // === NOVO: FUNÇÃO PARA GOVERNO DE MINAS GERAIS (MG) ===
        // =================================================================
        async function processarPdfGovMG(text) {
            // Hardcode 'MG' pois este parser é específico
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: 'MG', profissao: '', orgao: '' };
            let loansArray = [];

            console.log("Processando como Contracheque GOVERNO DE MINAS GERAIS...");

            // 1. Extrair Dados do Cliente
            try {
                // Formato: Nome: \n \nJakeline de Matos Castro\n \nMASP:
                const nomeMatch = text.match(/Nome:\s*\n\s*([^\n]+)\s*\n\s*MASP:/);
                if (nomeMatch) cliente.nome = nomeMatch[1].trim();

                // Formato: CPF: \n \n011.744.306-99\n \nPis/Pasep:
                const cpfMatch = text.match(/CPF:\s*\n\s*([^\n]+)\s*\n\s*Pis\/Pasep:/);
                if (cpfMatch) cliente.cpf = cpfMatch[1].trim();

                // Formato Tabela Cargo:
                // Admissão \nNome do Cargo \nSímbolo / Grau \nSituação Funcional \nÓrgão/Entidade\n
                // \n3\n \nProfessor de Educacao Basica\n \nPEB2 - C\n \nServidor Nomeado...\n \nSecretaria de Educacao
                const cargoBlockMatch = text.match(
                    /Admissão\s*Nome do Cargo\s*Símbolo \/ Grau\s*Situação Funcional\s*Órgão\/Entidade\s*\n\s*\d+\s*\n\s*([^\n]+)\s*\n\s*[^\n]+\s*\n\s*[^\n]+\s*\n\s*([^\n]+)/
                );

                if (cargoBlockMatch) {
                    cliente.profissao = cargoBlockMatch[1].trim(); // "Professor de Educacao Basica"
                    cliente.orgao = cargoBlockMatch[2].trim();     // "Secretaria de Educacao"
                }

                console.log("Cliente (GOV-MG):", cliente.nome, cliente.cpf);
                console.log("Cargo (GOV-MG):", cliente.profissao, cliente.orgao);

            } catch (e) {
                console.error("Erro ao parsear dados do cliente (GOV-MG):", e);
            }

            // 2. Extrair Contratos (Descontos)
            try {
                // Pega o bloco de texto entre "Descontos (R$)" e "Total: R$"
                const descontosBlockMatch = text.match(/Descontos \(R\$\)\s*([\s\S]+?)\s*Total:\s*R\$/);
                if (descontosBlockMatch) {
                    const descontosBlock = descontosBlockMatch[1];

                    // Regex para cada linha da tabela de descontos
                    // Formato: \nAdmissão \nReferência \nDescrição \nEspecificação \nParcela \nValor
                    // Ex: \n3 \nNormal \nB.pan - Emprest. i \n0 \n14 de 120 \n204,00
                    const rowRegex = /\n\s*(\d+)\s*\n\s*([^\n]+)\s*\n\s*([^\n]+)\s*\n\s*([^\n]+)\s*\n\s*([^\n]+)\s*\n\s*([\d.,]+)/g;

                    let matches = [...descontosBlock.matchAll(rowRegex)];
                    console.log(`Gov-MG: Encontrados ${matches.length} descontos.`);

                    matches.forEach((match) => {
                        const descricao = match[3].trim().toUpperCase();
                        const status = match[5].trim(); // Ex: "14 de 120" or "-"
                        const valorStr = match[6].trim();

                        // Filtrar apenas por palavras-chave de empréstimo
                        const isLoan = /EMPREST|EMP\.|CART BENEF|CART\.CREDITO|B\.PAN|BC\.SAFRA|BCO BMG|B\.DO BRASIL/.test(descricao);

                        if (isLoan) {
                            const valorParcelaNum = moedaParaFloat(valorStr);
                            if (valorParcelaNum > 0) {
                                loansArray.push({
                                    banco: match[3].trim(), // Usa a descrição como "banco"
                                    parcelaNum: valorParcelaNum,
                                    status: (status === '-') ? 'N/A' : status, // Trata o "-" como N/A
                                    contrato: 'N/A' // Não há número de contrato visível
                                });
                            }
                        }
                    });
                } else {
                    console.warn("Bloco de 'Descontos (R$)' não encontrado (GOV-MG).");
                }
            } catch (e) {
                console.error("Erro ao parsear descontos (GOV-MG):", e);
            }

            return { loans: loansArray, cliente: cliente };
        }


        // =================================================================
        // === NOVO: FUNÇÃO EXTRATO DE CONSIGNAÇÃO (GOV-MG) ===
        // =================================================================
        // =================================================================
        // === NOVO: FUNÇÃO EXTRATO DE CONSIGNAÇÃO (GOV-MG) ===
        // =================================================================
        async function processarPdfExtratoMG(text) {
            // Hardcode 'MG' pois este parser é específico
            let cliente = { nome: 'Não lido', cpf: 'Não lido', estado: 'MG', profissao: '', orgao: '' };
            let loansArray = [];

            console.log("Processando como Extrato de Consignação (GOV-MG)...");

            // 1. Extrair Dados do Cliente
            try {
                // Formato: Nome: \nJAKELINE DE MATOS CASTRO\n \nMASP:
                const nomeMatch = text.match(/Nome:\s*\n\s*([^\n]+)\s*\n\s*MASP:/);
                if (nomeMatch) cliente.nome = nomeMatch[1].trim();

                // Formato: CPF: \n000.000.000-00
                const cpfMatch = text.match(/CPF:\s*\n\s*([\d.-]+)/);
                if (cpfMatch) cliente.cpf = cpfMatch[1].trim();

                console.log("Cliente (Extrato MG):", cliente.nome, cliente.cpf);

            } catch (e) {
                console.error("Erro ao parsear dados do cliente (Extrato MG):", e);
            }

            // 2. Extrair Empréstimos (Consignações facultativas averbadas)
            try {
                // Pega o bloco de texto entre "Consignações facultativas averbadas" e "Reservas de margem de cartão"
                const consignacoesBlockMatch = text.match(/Consignações facultativas averbadas([\s\S]+?)Reservas de margem de cartão/);
                if (consignacoesBlockMatch) {
                    const consignacoesBlock = consignacoesBlockMatch[1];

                    // Regex para cada linha da tabela de empréstimos
                    // Formato: [Banco] \s+ [Tipo] \s+ [Contrato] \s+ [Parcelas] \s+ [Valor] \s+ [Faltante]
                    // Ex: Banco Safra S/A \n \n Emprestimo I \n \n 26684029 \n \n 39 de 96 \n \n R$ 128,37 \n \n 7445.46
                    const rowRegex = /([^\n]+)\s+([^\n]+)\s+([\d-]+)\s+([\d\sde]+)\s+(R\$\s*[\d.,]+)\s+([\d.]+)/g;

                    let matches = [...consignacoesBlock.matchAll(rowRegex)];
                    console.log(`Extrato MG: Encontrados ${matches.length} empréstimos.`);

                    matches.forEach((match) => {
                        const banco = match[1].trim();
                        // const tipo = match[2].trim(); // Não é mais usado no nome
                        const contrato = match[3].trim();
                        const status = match[4].trim();
                        const valorStr = match[5].trim();

                        const valorParcelaNum = moedaParaFloat(valorStr);

                        if (valorParcelaNum > 0) {
                            loansArray.push({
                                // ***** ESTA É A LINHA CORRIGIDA *****
                                banco: banco, // Apenas o nome do banco
                                parcelaNum: valorParcelaNum,
                                status: status,
                                contrato: contrato
                            });
                        }
                    });
                } else {
                    console.warn("Bloco 'Consignações facultativas' não encontrado (Extrato MG).");
                }

            } catch (e) {
                console.error("Erro ao parsear empréstimos (Extrato MG):", e);
            }

            // 3. Extrair Cartões (Reservas de margem de cartão)
            try {
                // Pega o bloco de texto após "Reservas de margem de cartão"
                const cartaoBlockMatch = text.match(/Reservas de margem de cartão([\s\S]+)/);
                if (cartaoBlockMatch) {
                    const cartaoBlock = cartaoBlockMatch[1];

                    // Regex para cada linha da tabela de cartões
                    // Formato: [Entidade] \s+ [Tipo] \s+ [Contrato] \s+ [Valor Reservado]
                    // Ex: Banco Bmg S/a \n \n Cartão Crédito \n \n 7214976 \n \n R$ 493,54
                    const cardRowRegex = /([^\n]+)\s+([^\n]+)\s+([\d]+)\s+(R\$\s*[\d.,]+)/g;

                    let cardMatches = [...cartaoBlock.matchAll(cardRowRegex)];
                    console.log(`Extrato MG: Encontrados ${cardMatches.length} cartões.`);

                    cardMatches.forEach((match) => {
                        const banco = match[1].trim();
                        const tipo = match[2].trim();
                        const contrato = match[3].trim();
                        const valorStr = match[4].trim();

                        const valorParcelaNum = moedaParaFloat(valorStr);

                        if (valorParcelaNum > 0) {
                            // Mantém a lógica original para cartões, pois "(Cartão Crédito)" é útil
                            loansArray.push({
                                banco: `${banco} (${tipo})`,
                                parcelaNum: valorParcelaNum,
                                status: 'N/A (Reserva)', // Cartão não tem status de parcela
                                contrato: contrato
                            });
                        }
                    });
                }

            } catch (e) {
                console.error("Erro ao parsear cartões (Extrato MG):", e);
            }

            return { loans: loansArray, cliente: cliente };
        }


        // =================================================================
        // === FUNÇÃO PRINCIPAL DE PARSE (ATUALIZADA) ===
        // =================================================================
        // =================================================================
        // === FUNÇÃO PRINCIPAL DE PARSE (ATUALIZADA) ===
        // =================================================================
        async function parsearPdf(event) {
            const file = event.target.files[0];
            if (!file) return;

            event.target.value = null;
            showLoading('Analisando...');
            const loadingText = document.getElementById("loading-text");

            const fileReader = new FileReader();
            fileReader.onload = async function () {
                let extractedText = '';
                // (Note: 'profissao' and 'orgao' are added to the default object)
                let result = { loans: [], cliente: { nome: '', cpf: '', estado: '', profissao: '', orgao: '' } };
                window.ultimoClientePDF = {}; // Limpa o cliente global

                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let textFound = false;

                    // --- PLANO A: TENTATIVA DE LEITURA RÁPIDA ---
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        if (textContent.items.length > 0) textFound = true;
                        // --- MELHORIA: Junta com \n (do depurador) ---
                        extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n--- FIM DA PÁGINA ' + i + ' ---\n\n';
                    }

                    // (hasRealData check is still good)
                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNATÁRIA') || extractedText.toUpperCase().includes('EMPRÉSTIMO') || extractedText.toUpperCase().includes('CPF') || extractedText.toUpperCase().includes('RUBRICA') || extractedText.toUpperCase().includes('COMPROVANTE DE RENDIMENTOS') || extractedText.toUpperCase().includes('MARGEM DE CONSIGNAÇÃO');

                    if (extractedText.trim().length < 50 || !hasRealData) {
                        textFound = false;
                        console.log("Texto 'limpo' não parece válido. Forçando OCR (Plano B).");
                    }

                    // --- PLANO B: FALLBACK PARA OCR (TESSERACT) ---
                    if (!textFound) {
                        console.warn("PDF parece ser uma imagem. Iniciando OCR...");
                        extractedText = '';
                        if (typeof Tesseract === 'undefined') throw new Error("Tesseract.js não foi carregado.");

                        const worker = await Tesseract.createWorker('por');
                        for (let i = 1; i <= pdf.numPages; i++) {
                            loadingText.textContent = `Lendo imagem: Página ${i} de ${pdf.numPages}...`;
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const { data: { text: ocrText } } = await worker.recognize(canvas);
                            extractedText += ocrText + '\n\n';
                        }
                        await worker.terminate();
                        console.log("OCR Concluído.");
                    }
                    // --- FIM DO PLANO B ---


                    // **** INÍCIO DA DETECÇÃO AUTOMÁTICA (ATUALIZADA) ****

                    // 1. Verifica se é Contracheque de Pensionista
                    if (extractedText.includes("DE BENEFICIÁRIO DE PENSÃO")) {
                        console.log("Detectado: Contracheque PENSIONISTA (SGP/SIGEPE)");
                        result = await processarPdfContrachequeSGP(extractedText); // (Chama a função antiga)

                        // 2. Verifica se é Contracheque de Servidor (O novo)
                    } else if (extractedText.includes("COMPROVANTE DE RENDIMENTOS - FOLHA")) {
                        console.log("Detectado: Contracheque SERVIDOR (SGP/SIGEPE)");
                        result = await processarPdfContrachequeServidor(extractedText);

                        // 3a. Verifica se é Demonstrativo de Pagamento GOV-MG
                    } else if (extractedText.includes("GOVERNO DO ESTADO DE MINAS GERAIS") && extractedText.includes("DEMONSTRATIVO DE PAGAMENTO")) {
                        console.log("Detectado: Contracheque GOVERNO DE MINAS GERAIS");
                        result = await processarPdfGovMG(extractedText);

                        // // NOVO DETECTOR (3b) //
                        // 3b. Verifica se é Extrato de Consignação GOV-MG
                    } else if (extractedText.includes("GOVERNO DO ESTADO DE MINAS GERAIS") && extractedText.includes("Margem de Consignação")) {
                        console.log("Detectado: Extrato de Consignação GOVERNO DE MINAS GERAIS");
                        result = await processarPdfExtratoMG(extractedText); // (Chama a NOVA função)

                        // 4. Verifica se é Extrato SIAPE
                    } else if (extractedText.includes("Extrato de Consignações Vigentes") || extractedText.includes("Rubrica\nSequência") || extractedText.includes("Rubrica\n")) {
                        console.log("Detectado: Extrato SIAPE");
                        result = await processarPdfSiape(extractedText);

                        // 5. Assume Exército como padrão
                    } else {
                        console.log("Detectado: Extrato Exército (Padrão)");
                        result = await processarPdfExercicio(extractedText);
                    }
                    // **** FIM DA DETECÇÃO ****

                    // --- Armazena o cliente lido globalmente ---
                    window.ultimoClientePDF = result.cliente;

                    showToast("Documento lido e convênio detectado!", "success");
                    showContractModal(result.loans, result.cliente); // Mostra o modal com os resultados

                } catch (error) {
                    console.error("Erro ao processar o PDF:", error);
                    showToast(`Erro ao ler o PDF: ${error.message}`, "danger");
                } finally {
                    hideLoading();
                }
            };
            fileReader.readAsArrayBuffer(file);
        }
        // =================================================================
        // === FUNÇÃO PRINCIPAL DE PARSE (ATUALIZADA) ===
        // =================================================================
        // =================================================================
        // === FUNÇÃO PRINCIPAL DE PARSE (CORRIGIDA) ===
        // =================================================================
        async function parsearPdf(event) {
            const file = event.target.files[0];
            if (!file) return;

            event.target.value = null;
            showLoading('Analisando...');
            const loadingText = document.getElementById("loading-text");

            const fileReader = new FileReader();
            fileReader.onload = async function () {
                let extractedText = '';
                // (Note: 'profissao' and 'orgao' are added to the default object)
                let result = { loans: [], cliente: { nome: '', cpf: '', estado: '', profissao: '', orgao: '' } };
                window.ultimoClientePDF = {}; // Limpa o cliente global

                try {
                    const typedarray = new Uint8Array(this.result);
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let textFound = false;

                    // --- PLANO A: TENTATIVA DE LEITURA RÁPIDA ---
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        if (textContent.items.length > 0) textFound = true;
                        // --- MELHORIA: Junta com \n (do depurador) ---
                        extractedText += textContent.items.map(item => item.str).join('\n') + '\n\n--- FIM DA PÁGINA ' + i + ' ---\n\n';
                    }

                    // (hasRealData check is still good)
                    const hasRealData = extractedText.toUpperCase().includes('CONSIGNATÁRIA') || extractedText.toUpperCase().includes('EMPRÉSTIMO') || extractedText.toUpperCase().includes('CPF') || extractedText.toUpperCase().includes('RUBRICA') || extractedText.toUpperCase().includes('COMPROVANTE DE RENDIMENTOS') || extractedText.toUpperCase().includes('MARGEM DE CONSIGNAÇÃO');

                    if (extractedText.trim().length < 50 || !hasRealData) {
                        textFound = false;
                        console.log("Texto 'limpo' não parece válido. Forçando OCR (Plano B).");
                    }

                    // --- PLANO B: FALLBACK PARA OCR (TESSERACT) ---
                    if (!textFound) {
                        console.warn("PDF parece ser uma imagem. Iniciando OCR...");
                        extractedText = '';
                        if (typeof Tesseract === 'undefined') throw new Error("Tesseract.js não foi carregado.");

                        const worker = await Tesseract.createWorker('por');
                        for (let i = 1; i <= pdf.numPages; i++) {
                            loadingText.textContent = `Lendo imagem: Página ${i} de ${pdf.numPages}...`;
                            const page = await pdf.getPage(i);
                            const viewport = page.getViewport({ scale: 2.0 });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d');
                            canvas.height = viewport.height;
                            canvas.width = viewport.width;
                            await page.render({ canvasContext: context, viewport: viewport }).promise;
                            const { data: { text: ocrText } } = await worker.recognize(canvas);
                            extractedText += ocrText + '\n\n';
                        }
                        await worker.terminate();
                        console.log("OCR Concluído.");
                    }
                    // --- FIM DO PLANO B ---


                    // **** INÍCIO DA DETECÇÃO AUTOMÁTICA (CORRIGIDA) ****

                    // Cria uma versão em maiúsculas do texto para detecção
                    const upperText = extractedText.toUpperCase();

                    // 1. Verifica se é Contracheque de Pensionista
                    if (upperText.includes("DE BENEFICIÁRIO DE PENSÃO")) {
                        console.log("Detectado: Contracheque PENSIONISTA (SGP/SIGEPE)");
                        // NOTA: A função processarPdfContrachequeSGP() não foi fornecida, 
                        // certifique-se que ela existe ou ajuste o nome abaixo.
                        // Se ela não existir, o código vai falhar aqui.
                        // Assumindo que você a tenha em algum lugar...
                        try {
                            result = await processarPdfContrachequeSGP(extractedText);
                        } catch (e) {
                            console.error("Função 'processarPdfContrachequeSGP' não encontrada ou falhou.", e);
                            // Tenta o próximo para não parar
                            result = await processarPdfExercicio(extractedText);
                        }

                        // 2. Verifica se é Contracheque de Servidor (O novo)
                    } else if (upperText.includes("COMPROVANTE DE RENDIMENTOS - FOLHA")) {
                        console.log("Detectado: Contracheque SERVIDOR (SGP/SIGEPE)");
                        result = await processarPdfContrachequeServidor(extractedText);

                        // 3a. Verifica se é Demonstrativo de Pagamento GOV-MG
                    } else if (upperText.includes("GOVERNO DO ESTADO DE MINAS GERAIS") && upperText.includes("DEMONSTRATIVO DE PAGAMENTO")) {
                        console.log("Detectado: Contracheque GOVERNO DE MINAS GERAIS");
                        result = await processarPdfGovMG(extractedText);

                        // 3b. Verifica se é Extrato de Consignação GOV-MG (A verificação agora é em maiúsculas)
                    } else if (upperText.includes("GOVERNO DO ESTADO DE MINAS GERAIS") && upperText.includes("MARGEM DE CONSIGNAÇÃO")) {
                        console.log("Detectado: Extrato de Consignação GOVERNO DE MINAS GERAIS");
                        result = await processarPdfExtratoMG(extractedText); // (Chama a função correta)

                        // 4. Verifica se é Extrato SIAPE
                    } else if (upperText.includes("EXTRATO DE CONSIGNAÇÕES VIGENTES") || upperText.includes("RUBRICA\nSEQUÊNCIA") || upperText.includes("RUBRICA\n")) {
                        console.log("Detectado: Extrato SIAPE");
                        result = await processarPdfSiape(extractedText);

                        // 5. Assume Exército como padrão
                    } else {
                        console.log("Detectado: Extrato Exército (Padrão)");
                        result = await processarPdfExercicio(extractedText);
                    }
                    // **** FIM DA DETECÇÃO ****

                    // --- Armazena o cliente lido globalmente ---
                    window.ultimoClientePDF = result.cliente;

                    showToast("Documento lido e convênio detectado!", "success");
                    showContractModal(result.loans, result.cliente); // Mostra o modal com os resultados

                } catch (error) {
                    console.error("Erro ao processar o PDF:", error);
                    showToast(`Erro ao ler o PDF: ${error.message}`, "danger");
                } finally {
                    hideLoading();
                }
            };
            fileReader.readAsArrayBuffer(file);
        }

        // ##################################################################
        // ### FIM - NOVAS FUNÇÕES ###
        // ##################################################################


        // --- INICIALIZAÇÃO E EVENT LISTENERS (Atualizado) ---
        document.addEventListener('DOMContentLoaded', () => {
            // Funções de inicialização existentes
            setarDataAtual();
            atualizarPreview(); // Chama para renderizar o placeholder da tabela

            // Listeners do formulário existentes
            document.querySelectorAll('#form-container input').forEach(input => { input.addEventListener('input', atualizarPreview); });
            document.querySelectorAll('.campo-moeda').forEach(input => { input.addEventListener('blur', function () { if (this.value.trim() !== "") { const valorNumerico = moedaParaFloat(this.value); this.value = formatarMoeda(valorNumerico); atualizarPreview(); } }); });
            document.getElementById('gerar-pdf').addEventListener('click', gerarPdf);


            // === NOVOS Event Listeners (para Leitor de PDF) ===
            const uploadArea = document.getElementById('upload-label');

            // Eventos de Drag & Drop
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('hover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('hover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('hover');
                if (e.dataTransfer.files.length > 0 && e.dataTransfer.files[0].type === "application/pdf") {
                    document.getElementById('pdf-upload').files = e.dataTransfer.files;
                    document.getElementById('pdf-upload').dispatchEvent(new Event('change'));
                } else if (e.dataTransfer.files.length > 0) {
                    showToast("Por favor, arraste apenas arquivos PDF.", "warning");
                }
            });

            // Evento de clique (para abrir seletor)
            document.getElementById("pdf-upload").addEventListener("change", parsearPdf);

            // Botão Limpar Contratos
            document.getElementById('limpar-contratos-btn').addEventListener('click', () => {
                limparCamposContrato();
                atualizarPreview(); // Atualiza o preview para mostrar a tabela limpa
                showToast("Campos de contrato limpos.", "success");
            });

            // Botões do Modal
            document.getElementById('modal-cancel-btn').addEventListener('click', hideContractModal);
            document.getElementById('modal-apply-btn').addEventListener('click', applySelectedContracts);

            // --- NOVO: Listeners para Contratos Dinâmicos ---
            document.getElementById('btn-add-contrato').addEventListener('click', () => {
                adicionarLinhaContrato();
                atualizarPreview(); // Atualiza o preview
            });

            // Event Listener para REMOVER (usando delegação de evento)
            document.getElementById('contratos-dinamicos-container').addEventListener('click', function (e) {
                if (e.target && e.target.classList.contains('btn-remover-contrato')) {
                    e.target.closest('.contrato-dinamico-item').remove();
                    atualizarPreview(); // Atualiza o preview
                }
            });

            // --- NOVO: Listener para Botão de Logout ---
            document.getElementById('btn-logout').addEventListener('click', () => {
                if (confirm("Você tem certeza que deseja sair?")) {
                    localStorage.removeItem('isAuthenticated');
                    window.location.replace('index.html');
                }
            });

            // --- NOVO: Listener para API de CEP ---
            document.getElementById('cep').addEventListener('blur', buscarCep); // 'blur' é quando o campo perde o foco
        });
    </script>

</body>

</html>